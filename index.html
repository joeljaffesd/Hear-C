<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Hear-C: Browser-Based C++ Audio Development</title>
    <!-- Favicon -->
    <link rel="icon" href="logo.ico" type="image/x-icon">
    <link rel="shortcut icon" href="logo.ico" type="image/x-icon">
    <!-- Monaco Editor -->
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <!-- Main application styles -->
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <!-- Main IDE Layout inspired by Faust IDE -->
    <div class="ide-layout">
      <!-- Header -->
      <div class="header">
        <div class="header-logo">
          <img src="logo.ico" alt="Hear-C Logo" class="logo-icon">
        </div>
        <h1>Hear-C: Browser-Based C++ Audio Development</h1>
        <a href="https://github.com/joeljaffesd/Hear-C" target="_blank" class="github-link" title="View on GitHub">
          <svg class="github-icon" viewBox="0 0 16 16" width="24" height="24" fill="currentColor">
            <path d="M8 0c4.42 0 8 3.58 8 8 0 3.54-2.29 6.53-5.47 7.59-.4-.07-.55-.17-.55-.38 0-.19.01-.82.01-1.49 2.01.37 2.53-.49 2.69-.94.09-.23.48-.94.82-1.13.28-.15.68-.52-.01-.53-.63-.01-1.08.58-1.23.82-.72 1.21-1.87.87-2.33.66-.07-.52-.28-.87-.51-1.07 1.78-.2 3.64-.89 3.64-3.95 0-.87-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.21-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.21.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.31-.55.38C2.29 14.53 0 11.54 0 8c0-4.42 3.58-8 8-8z"/>
          </svg>
        </a>
      </div>
      
      <!-- Main Content Area -->
      <div class="main-content">
        <!-- Center: Code Editor -->
        <div class="editor-section">
          <div class="editor-header">
            <div class="editor-title">user.h</div>
            <div class="editor-status" id="editor-status">Loading compiler...</div>
          </div>
          <div id="monaco-editor"></div>
        </div>
        
        <!-- Right Panel: Controls -->
        <div class="right-panel">
          <div class="panel-section">
            <h3>Build &amp; Run</h3>
            <div class="control-group">
              <button id="saveButton" class="panel-button save" type="button">
                &#x1F4BE; Save
              </button>
              <button id="rebuildButton" class="panel-button build" disabled>
                &#x1F528; Build &amp; Run
              </button>
              <button id="resetButton" class="panel-button reset" type="button">
                &#x1F504; Reset to Default
              </button>
            </div>
          </div>
          
          <div class="panel-section">
            <h3>Audio Control</h3>
            <div class="control-group">
              <button id="startAudio" class="panel-button audio" disabled>
                &#x25B6;&#xFE0F; Start Audio
              </button>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- Bottom Panel: Console Output -->
      <div class="bottom-panel">
        <div class="console-header">
          <h3>Console Output</h3>
          <div class="console-controls">
            <button id="clearConsole" class="console-button">&#x1F5D1;&#xFE0F; Clear</button>
          </div>
        </div>
        <div class="console-content">
          <textarea id="output" readonly placeholder="Build output and messages will appear here..."></textarea>
        </div>
      </div>
    </div>

    <!-- Error display container for compilation errors -->
    <div id="error-container">
      <div class="error-header">
        <span>Compilation Errors</span>
        <button class="error-close" id="error-close" title="Close error panel">&times;</button>
      </div>
      <div class="error-content" id="error-content"></div>
    </div>

    <script type='text/javascript'>
      var outputElement = document.getElementById('output');
      var audioContext = null;
      var audioStarted = false;
      var compiledWasmModule = null;
      var scriptNode = null;
      var wasmInstance = null;

      // C++ template that wraps user.h for client-side compilation.
      // Provides the same macros as the original main.cpp and exposes
      // hear_c_init / hear_c_next_sample as extern "C" entry points.
      var CPP_TEMPLATE = [
        '#include <cmath>',
        '#include <iostream>',
        '#ifndef M_PI',
        '#define M_PI 3.14159265358979323846',
        '#endif',
        '#define SAMPLE_RATE 44100',
        '#define BUFFER_SIZE 1024',
        '#define CHANNELS 2',
        '// User code:',
        '{USER_CODE}',
        'extern "C" {',
        '  void __attribute__((used)) hear_c_init() { init(); }',
        '  float __attribute__((used)) hear_c_next_sample() { return nextSample(); }',
        '}',
        'int main() {',
        '  std::cout << "Hear-C: Build successful!" << std::endl;',
        '  return 0;',
        '}'
      ].join('\n');

      function stripAnsi(str) {
        return str.replace(/\x1b\[[0-9;]*[mGKHF]/g, '');
      }

      function appendToOutput(text) {
        outputElement.value += stripAnsi(text);
        outputElement.scrollTop = outputElement.scrollHeight;
      }

      // Monaco Editor Setup
      var editor;
      var originalCode = '';
      var editorActive = false;
      var STORAGE_KEY = 'hear_c_user_code';
      var DEFAULT_CODE_KEY = 'hear_c_default_code';

      window.addEventListener('load', function() {
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
        
        require(['vs/editor/editor.main'], function() {
          editor = monaco.editor.create(document.getElementById('monaco-editor'), {
            value: '',
            language: 'cpp',
            theme: 'vs-dark',
            fontSize: 14,
            lineNumbers: 'on',
            roundedSelection: false,
            scrollBeyondLastLine: false,
            minimap: { enabled: true },
            automaticLayout: true,
            tabSize: 2,
            insertSpaces: true,
            wordWrap: 'on',
            bracketPairColorization: { enabled: true },
            suggest: { enabled: true },
            quickSuggestions: { other: true, comments: true, strings: true }
          });

          var resizeTimeout;
          window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
              if (editor) editor.layout();
            }, 100);
          });

          loadSourceCode();

          editor.onDidFocusEditorWidget(function() { editorActive = true; });
          editor.onDidBlurEditorWidget(function() { editorActive = false; });
          editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
            saveSourceCode();
          });
          console.log('Monaco Editor initialized successfully');
        });
      });

      function loadSourceCode() {
        var savedCode = localStorage.getItem(STORAGE_KEY);
        if (savedCode) {
          originalCode = savedCode;
          if (editor) editor.setValue(savedCode);
          return;
        }
        fetch('/source')
          .then(function(response) {
            if (!response.ok) throw new Error('HTTP error! Status: ' + response.status);
            return response.text();
          })
          .then(function(code) {
            originalCode = code;
            if (editor) editor.setValue(code);
            localStorage.setItem(DEFAULT_CODE_KEY, code);
          })
          .catch(function(error) {
            console.error('Error loading source code:', error);
          });
      }

      function saveSourceCode() {
        var code = editor.getValue();
        try {
          localStorage.setItem(STORAGE_KEY, code);
          originalCode = code;
          var saveButton = document.getElementById('saveButton');
          var originalText = saveButton.textContent;
          saveButton.textContent = 'Saved \u2713';
          setTimeout(function() { saveButton.textContent = originalText; }, 1500);
        } catch (error) {
          console.error('Error saving to localStorage:', error);
          alert('Failed to save code to browser storage.');
        }
      }

      function updateEditorStatus(message, isError) {
        var statusEl = document.getElementById('editor-status');
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.style.color = isError ? '#ff7b72' : '#4ec9b0';
        }
      }

      function showError(errorMessage) {
        updateEditorStatus('Build failed', true);
        var errorContainer = document.getElementById('error-container');
        var errorContent = document.getElementById('error-content');
        errorContainer.classList.add('visible');
        errorContent.innerHTML = '';
        var lines = errorMessage.split('\n');
        lines.forEach(function(line) {
          var div = document.createElement('div');
          if (line.includes('error:')) {
            div.className = 'error-line error';
          } else if (line.includes('warning:')) {
            div.className = 'error-line warning';
          } else {
            div.className = 'error-line';
          }
          div.textContent = line;
          errorContent.appendChild(div);
        });
        setTimeout(function() { errorContainer.classList.remove('visible'); }, 10000);
      }

      // =====================================================================
      // wasm-clang Worker API
      // =====================================================================

      function WorkerAPI() {
        this.nextResponseId = 0;
        this.responseCBs = new Map();
        this.worker = new Worker('worker.js');
        var channel = new MessageChannel();
        this.port = channel.port1;
        this.port.onmessage = this.onmessage.bind(this);
        var remotePort = channel.port2;
        this.worker.postMessage({id: 'constructor', data: remotePort}, [remotePort]);
      }

      WorkerAPI.prototype.runAsync = function(id, options) {
        var responseId = this.nextResponseId++;
        var self = this;
        var responsePromise = new Promise(function(resolve, reject) {
          self.responseCBs.set(responseId, {resolve: resolve, reject: reject});
        });
        this.port.postMessage({id: id, responseId: responseId, data: options});
        return responsePromise;
      };

      WorkerAPI.prototype.compileAndGetWasm = function(code) {
        return this.runAsync('compileAndGetWasm', code);
      };

      WorkerAPI.prototype.onmessage = function(event) {
        switch (event.data.id) {
          case 'write':
            appendToOutput(event.data.data);
            break;

          case 'ready':
            updateEditorStatus('Ready');
            document.getElementById('rebuildButton').disabled = false;
            appendToOutput('Compiler ready. Click "Build & Run" to compile your code.\n');
            break;

          case 'error':
            updateEditorStatus('Compiler error', true);
            appendToOutput('Compiler initialization error: ' + event.data.data + '\n');
            break;

          case 'runAsync': {
            var responseId = event.data.responseId;
            var promise = this.responseCBs.get(responseId);
            if (promise) {
              this.responseCBs.delete(responseId);
              promise.resolve(event.data.data);
            }
            break;
          }
        }
      };

      var workerAPI = new WorkerAPI();

      // =====================================================================
      // WASI stubs for instantiating the compiled audio module
      // =====================================================================

      function WasiExit(code) {
        this.code = code;
        this.message = 'exit ' + code;
      }
      WasiExit.prototype = Object.create(Error.prototype);

      function createWasiImports(getMemory) {
        return {
          wasi_unstable: {
            proc_exit: function(code) { throw new WasiExit(code); },

            fd_write: function(fd, iovs, iovs_len, nwritten_out) {
              var memory = getMemory();
              if (!memory) return 1;
              var view = new DataView(memory.buffer);
              var total = 0;
              var text = '';
              for (var i = 0; i < iovs_len; i++) {
                var ptr = view.getUint32(iovs + i * 8, true);
                var len = view.getUint32(iovs + i * 8 + 4, true);
                var bytes = new Uint8Array(memory.buffer, ptr, len);
                text += new TextDecoder().decode(bytes);
                total += len;
              }
              view.setUint32(nwritten_out, total, true);
              if (fd === 1 || fd === 2) appendToOutput(text);
              return 0;
            },

            args_sizes_get: function(argc_out, argv_buf_size_out) {
              var memory = getMemory();
              if (!memory) return 0;
              var view = new DataView(memory.buffer);
              view.setUint32(argc_out, 0, true);
              view.setUint32(argv_buf_size_out, 0, true);
              return 0;
            },

            args_get: function(argv_ptr, argv_buf_ptr) { return 0; },

            environ_sizes_get: function(count_out, buf_size_out) {
              var memory = getMemory();
              if (!memory) return 0;
              var view = new DataView(memory.buffer);
              view.setUint32(count_out, 0, true);
              view.setUint32(buf_size_out, 0, true);
              return 0;
            },

            environ_get: function(environ_ptr, environ_buf) { return 0; },

            random_get: function(buf, buf_len) {
              var memory = getMemory();
              if (!memory) return 0;
              var bytes = new Uint8Array(memory.buffer, buf, buf_len);
              crypto.getRandomValues(bytes);
              return 0;
            },

            clock_time_get: function(clock_id, precision, time_out) {
              var memory = getMemory();
              if (!memory) return 0;
              var now = BigInt(Date.now()) * 1000000n;
              new DataView(memory.buffer).setBigUint64(time_out, now, true);
              return 0;
            },

            poll_oneoff: function(in_ptr, out_ptr, nsubscriptions, nevents_out) {
              var memory = getMemory();
              if (!memory) return 0;
              new DataView(memory.buffer).setUint32(nevents_out, 0, true);
              return 0;
            },

            fd_seek: function(fd, offset_low, offset_high, whence, newoffset_out) { return 0; },
            fd_close: function(fd) { return 0; },
            fd_read: function(fd, iovs, iovs_len, nread_out) {
              var memory = getMemory();
              if (!memory) return 0;
              new DataView(memory.buffer).setUint32(nread_out, 0, true);
              return 0;
            },
            fd_fdstat_get: function(fd, stat_out) { return 0; },
            fd_prestat_get: function(fd, prestat_out) { return 8; },
            fd_prestat_dir_name: function(fd, path_ptr, path_len) { return 28; },
            path_open: function() { return 28; }
          }
        };
      }

      // =====================================================================
      // Build & Audio
      // =====================================================================

      function buildAndRun() {
        var rebuildButton = document.getElementById('rebuildButton');
        rebuildButton.disabled = true;
        rebuildButton.textContent = 'Building...';
        updateEditorStatus('Compiling...', false);

        document.getElementById('error-container').classList.remove('visible');

        saveSourceCode();
        var userCode = editor.getValue();
        var fullCode = CPP_TEMPLATE.replace('{USER_CODE}', userCode);

        appendToOutput('\n--- Building ---\n');

        workerAPI.compileAndGetWasm(fullCode).then(function(result) {
          if (result.success && result.wasm) {
            appendToOutput('Linking complete.\n');
            return WebAssembly.compile(result.wasm).then(function(mod) {
              compiledWasmModule = mod;
              updateEditorStatus('Build successful!', false);
              appendToOutput('Build successful! Click "Start Audio" to run.\n');
              document.getElementById('startAudio').disabled = false;
            });
          } else {
            var errMsg = result.error || 'Unknown compilation error';
            appendToOutput('Build failed: ' + errMsg + '\n');
            showError(errMsg);
          }
        }).catch(function(err) {
          appendToOutput('Build error: ' + err.message + '\n');
          showError(err.message);
        }).finally(function() {
          rebuildButton.disabled = false;
          rebuildButton.textContent = '\uD83D\uDD28 Build & Run';
          if (document.getElementById('editor-status').textContent === 'Compiling...') {
            updateEditorStatus('Ready');
          }
        });
      }

      function startAudio() {
        if (!compiledWasmModule) {
          alert('Please build the code first!');
          return;
        }

        // Close previous audio context if any
        if (audioContext) {
          if (scriptNode) {
            scriptNode.disconnect();
            scriptNode = null;
          }
          audioContext.close().catch(function() {});
          audioContext = null;
        }

        try {
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          audioContext = new AudioContext({sampleRate: 44100});

          var wasmMemory = null;
          var wasiImports = createWasiImports(function() { return wasmMemory; });

          WebAssembly.instantiate(compiledWasmModule, wasiImports).then(function(instance) {
            wasmMemory = instance.exports.memory;
            wasmInstance = instance;

            try {
              instance.exports._start();
            } catch (e) {
              if (!(e instanceof WasiExit && e.code === 0)) {
                throw e;
              }
            }

            var nextSample = instance.exports.hear_c_next_sample;
            if (!nextSample) {
              throw new Error('hear_c_next_sample not found. Make sure your code defines nextSample().');
            }

            // ScriptProcessorNode is deprecated but used here because AudioWorklet
            // would require sending compiled WASM bytes to a separate worklet context,
            // adding significant complexity for this dynamic compilation use case.
            scriptNode = audioContext.createScriptProcessor(1024, 0, 2);
            scriptNode.onaudioprocess = function(event) {
              var outputL = event.outputBuffer.getChannelData(0);
              var outputR = event.outputBuffer.getChannelData(1);
              for (var i = 0; i < outputL.length; i++) {
                var sample = nextSample();
                outputL[i] = sample;
                outputR[i] = sample;
              }
            };
            scriptNode.connect(audioContext.destination);

            audioStarted = true;
            document.getElementById('startAudio').textContent = '\u23F8\uFE0F Stop Audio';
            appendToOutput('Audio started.\n');
          }).catch(function(error) {
            console.error('Error starting audio:', error);
            appendToOutput('Error starting audio: ' + error.message + '\n');
            alert('Error starting audio. Check the console output for details.');
          });
        } catch (error) {
          console.error('Error starting audio:', error);
          appendToOutput('Error starting audio: ' + error.message + '\n');
          alert('Error starting audio. Check the console output for details.');
        }
      }

      function stopAudio() {
        try {
          if (scriptNode) {
            scriptNode.disconnect();
            scriptNode = null;
          }
          if (audioContext) {
            audioContext.suspend();
          }
          audioStarted = false;
          document.getElementById('startAudio').textContent = '\u25B6\uFE0F Start Audio';
          appendToOutput('Audio stopped.\n');
        } catch (error) {
          console.error('Error stopping audio:', error);
        }
      }

      window.addEventListener('load', function() {
        document.getElementById('clearConsole').addEventListener('click', function(event) {
          event.preventDefault();
          document.getElementById('output').value = '';
          updateEditorStatus('Console cleared');
          setTimeout(function() { updateEditorStatus('Ready'); }, 2000);
        });

        document.getElementById('error-close').addEventListener('click', function(event) {
          event.preventDefault();
          document.getElementById('error-container').classList.remove('visible');
        });

        document.getElementById('saveButton').addEventListener('click', function(event) {
          event.preventDefault();
          saveSourceCode();
        });

        document.getElementById('resetButton').addEventListener('click', function(event) {
          event.preventDefault();
          if (confirm('Reset to default code? This will lose your current changes.')) {
            resetToDefault();
          }
        });

        document.getElementById('startAudio').addEventListener('click', function(event) {
          event.preventDefault();
          event.stopPropagation();
          if (!audioStarted) {
            startAudio();
          } else {
            stopAudio();
          }
        });

        document.getElementById('rebuildButton').addEventListener('click', function(event) {
          event.preventDefault();
          buildAndRun();
        });
      });

      function resetToDefault() {
        localStorage.removeItem(STORAGE_KEY);

        var cachedDefault = localStorage.getItem(DEFAULT_CODE_KEY);

        if (cachedDefault && editor) {
          editor.setValue(cachedDefault);
          updateEditorStatus('Reset to default');
          setTimeout(function() { updateEditorStatus('Ready'); }, 2000);
        } else {
          updateEditorStatus('Loading default...', false);
          fetch('/source')
            .then(function(response) {
              if (!response.ok) throw new Error('HTTP error! Status: ' + response.status);
              return response.text();
            })
            .then(function(code) {
              if (editor) {
                editor.setValue(code);
                localStorage.setItem(DEFAULT_CODE_KEY, code);
                updateEditorStatus('Reset to default');
                setTimeout(function() { updateEditorStatus('Ready'); }, 2000);
              }
            })
            .catch(function(error) {
              console.error('Error loading default code:', error);
              updateEditorStatus('Reset failed', true);
              setTimeout(function() { updateEditorStatus('Ready'); }, 3000);
            });
        }
      }
    </script>
  </body>
</html>
